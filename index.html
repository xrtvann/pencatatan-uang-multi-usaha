<!DOCTYPE html>
<html lang="id" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif']
                    },
                    colors: {
                        base: {
                            light: '#F8FAFC',
                            dark: '#0F172A'
                        },
                        surface: {
                            light: '#FFFFFF',
                            dark: '#1E293B'
                        },
                        text: {
                            light: '#1F2937',
                            dark: '#E2E8F0'
                        },
                        border: {
                            light: '#E2E8F0',
                            dark: '#334155'
                        },
                        accent: {
                            light: '#3B82F6',
                            dark: '#60A5FA'
                        },
                        secondary: {
                            light: '#9CA3AF',
                            dark: '#94A3B8'
                        },
                        danger: {
                            light: '#EF4444',
                            dark: '#F87171'
                        },
                        success: {
                            light: '#10B981',
                            dark: '#34D399'
                        }
                    }
                }
            }
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body
    class="bg-base-light dark:bg-base-dark text-text-light dark:text-text-dark font-sans transition-colors duration-500">
    <div class="flex h-screen overflow-hidden relative">
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 w-64 transform -translate-x-full md:translate-x-0 md:relative md:block bg-surface-light dark:bg-surface-dark p-4 transition-transform duration-300 z-50">
            <h2 class="text-2xl font-bold mb-6">Finance Tracker</h2>
            <ul class="space-y-2">
                <li><a href="#" id="menu-dashboard" onclick="loadDashboard()"
                        class="block px-4 py-2 rounded transition-colors duration-200 hover:bg-accent-light dark:hover:bg-accent-dark hover:text-white"><i
                            class="fas fa-chart-line mr-2"></i>Dashboard</a></li>
            </ul>
            <div class="mt-8">
                <h3 class="text-sm uppercase font-semibold text-secondary-light dark:text-secondary-dark mb-2">Usaha
                </h3>
                <div class="space-y-2">
                    <a href="#" id="menu-geprek" onclick="loadContent('geprek')"
                        class="block px-4 py-2 rounded transition-colors duration-200 hover:bg-accent-light dark:hover:bg-accent-dark hover:text-white"><i
                            class="fas fa-drumstick-bite mr-2"></i>Geprek</a>
                    <a href="#" id="menu-kaos" onclick="loadContent('kaos')"
                        class="block px-4 py-2 rounded transition-colors duration-200 hover:bg-accent-light dark:hover:bg-accent-dark hover:text-white"><i
                            class="fas fa-shirt mr-2"></i>Kaos</a>
                </div>
            </div>
            <div class="mt-8">
                <h3 class="text-sm uppercase font-semibold text-secondary-light dark:text-secondary-dark mb-2">Laporan
                </h3>
                <ul class="space-y-2">
                    <li><a href="#" id="menu-report" onclick="loadReport()"
                            class="block px-4 py-2 rounded transition-colors duration-200 hover:bg-accent-light dark:hover:bg-accent-dark hover:text-white"><i
                                class="fas fa-chart-area mr-2"></i>Laporan</a></li>
                </ul>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header
                class="flex items-center justify-between bg-surface-light dark:bg-surface-dark p-4 border-b border-border-light dark:border-border-dark sticky top-0 z-40">
                <div class="flex items-center w-full md:w-auto gap-2">
                    <button onclick="toggleSidebar()"
                        class="block md:hidden text-2xl text-accent-light dark:text-accent-dark z-50">
                        <i id="menu-toggle-icon" class="fas fa-bars"></i>
                    </button>
                    <div class="relative flex-1 max-w-[270px] sm:max-w-xs md:hidden">
                        <input type="text" id="mobile-search" placeholder="Cari"
                            class="w-full px-3 py-2 rounded bg-base-light dark:bg-base-dark text-text-light dark:text-text-dark pl-9 border border-border-light dark:border-border-dark text-sm"
                            autocomplete="off" />
                        <i
                            class="fas fa-search absolute left-3 top-3 text-secondary-light dark:text-secondary-dark"></i>
                        <ul id="mobile-search-suggestions"
                            class="absolute left-0 right-0 mt-1 bg-white dark:bg-base-dark border border-border-light dark:border-border-dark rounded shadow z-50 hidden max-h-48 overflow-y-auto">
                        </ul>
                    </div>
                </div>
                <div class="w-full md:w-1/2 max-w-md relative hidden md:block">
                    <input type="text" id="desktop-search" placeholder="Cari"
                        class="w-full px-4 py-2 rounded bg-base-light dark:bg-base-dark text-text-light dark:text-text-dark pl-10 border border-border-light dark:border-border-dark"
                        autocomplete="off" />
                    <i class="fas fa-search absolute left-3 top-3 text-secondary-light dark:text-secondary-dark"></i>
                    <ul id="desktop-search-suggestions"
                        class="absolute left-0 right-0 mt-1 bg-white dark:bg-base-dark border border-border-light dark:border-border-dark rounded shadow z-50 hidden max-h-48 overflow-y-auto">
                    </ul>
                </div>
                <div class="flex items-center ml-auto">
                    <button onclick="toggleDarkMode()" class="text-xl text-accent-light dark:text-accent-dark">
                        <i id="theme-icon" class="fas"></i>
                    </button>
                </div>
            </header>
            <main id="app" class="flex-1 overflow-auto p-6"></main>
        </div>
    </div>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden">
    </div>



    <style>
        html,
        body,
        .bg-base-light,
        .bg-base-dark,
        .bg-surface-light,
        .bg-surface-dark,
        .text-text-light,
        .text-text-dark,
        .border-border-light,
        .border-border-dark,
        .bg-accent-light,
        .bg-accent-dark,
        .bg-success-light,
        .bg-success-dark,
        .bg-danger-light,
        .bg-danger-dark,
        .text-success-light,
        .text-success-dark,
        .text-danger-light,
        .text-danger-dark,
        .text-accent-light,
        .text-accent-dark,
        .text-secondary-light,
        .text-secondary-dark,
        .bg-white,
        .dark\:bg-gray-800,
        .bg-gray-800 {
            transition: background-color 0.5s, color 0.5s, border-color 0.5s;
        }
    </style>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('menu-toggle-icon');
            const overlay = document.getElementById('overlay');
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            sidebar.classList.toggle('-translate-x-full');
            icon.className = isOpen ? 'fas fa-bars' : 'fas fa-times';
            overlay.classList.toggle('hidden', isOpen);
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            updateIcon();
        }

        function updateIcon() {
            const icon = document.getElementById('theme-icon');
            icon.className = document.documentElement.classList.contains('dark') ? 'fas fa-moon' : 'fas fa-sun';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateIcon();
        }

        function setActiveMenu(id) {
            document.querySelectorAll('aside a').forEach(a => a.classList.remove('bg-accent-light', 'dark:bg-accent-dark', 'text-white'));
            const menu = document.getElementById(`menu-${id}`);
            if (menu) menu.classList.add('bg-accent-light', 'dark:bg-accent-dark', 'text-white');
        }

        function loadDashboard() {
            setActiveMenu('dashboard');
            const app = document.getElementById('app');
            app.innerHTML = `
        <h2 class="text-2xl font-semibold mb-4">Ringkasan Grafik</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
            <h3 class="mb-2 font-semibold">Geprek</h3>
            <canvas id="chart-geprek" height="180"></canvas>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
            <h3 class="mb-2 font-semibold">Kaos</h3>
            <canvas id="chart-kaos" height="180"></canvas>
          </div>
        </div>`;
            renderChart('geprek');
            renderChart('kaos');
        }

        function renderChart(type) {
            const ctx = document.getElementById(`chart-${type}`);
            const data = JSON.parse(localStorage.getItem(`transaksi-${type}`) || '[]');
            const pemasukan = data.filter(d => d.type === 'pemasukan').reduce((a, b) => a + Number(b.amount), 0);
            const pengeluaran = data.filter(d => d.type === 'pengeluaran').reduce((a, b) => a + Number(b.amount), 0);
            const total = pemasukan + pengeluaran || 1;
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pemasukan', 'Pengeluaran'],
                    datasets: [{
                        label: '% Total',
                        data: [pemasukan / total * 100, pengeluaran / total * 100],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverOffset: 12
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.raw.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadContent(type) {
            setActiveMenu(type);
            const app = document.getElementById('app');
            const now = new Date().toISOString().slice(0, 10);
            const dataKey = `transaksi-${type}`;
            let data = JSON.parse(localStorage.getItem(dataKey) || '[]');
            // MIGRASI: Tambahkan id unik jika belum ada (untuk data lama)
            let migrated = false;
            data.forEach(tx => {
                if (!tx.id) {
                    tx.id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                    migrated = true;
                }
            });
            if (migrated) {
                localStorage.setItem(dataKey, JSON.stringify(data));
            }
            const pemasukan = data.filter(d => d.type === 'pemasukan').reduce((a, b) => a + Number(b.amount), 0);
            const pengeluaran = data.filter(d => d.type === 'pengeluaran').reduce((a, b) => a + Number(b.amount), 0);
            const saldo = pemasukan - pengeluaran;

            // Fungsi untuk update ringkasan
            function updateSummary() {
                const pemasukan = data.filter(d => d.type === 'pemasukan').reduce((a, b) => a + Number(b.amount), 0);
                const pengeluaran = data.filter(d => d.type === 'pengeluaran').reduce((a, b) => a + Number(b.amount), 0);
                const saldo = pemasukan - pengeluaran;
                document.querySelectorAll('.pemasukan-text').forEach(el => el.textContent = `Rp ${pemasukan.toLocaleString('id-ID')}`);
                document.querySelectorAll('.pengeluaran-text').forEach(el => el.textContent = `Rp ${pengeluaran.toLocaleString('id-ID')}`);
                document.querySelectorAll('.saldo-text').forEach(el => el.textContent = `Rp ${saldo.toLocaleString('id-ID')}`);
            }

            app.innerHTML = `
    <h2 class="text-2xl font-semibold mb-4">Transaksi Usaha ${type.charAt(0).toUpperCase() + type.slice(1)}</h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow text-center">
        <p class="text-secondary-light dark:text-secondary-dark text-sm">Pemasukan</p>
        <p class="text-lg font-semibold text-success-light dark:text-success-dark pemasukan-text">Rp ${pemasukan.toLocaleString('id-ID')}</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow text-center">
        <p class="text-secondary-light dark:text-secondary-dark text-sm">Pengeluaran</p>
        <p class="text-lg font-semibold text-danger-light dark:text-danger-dark pengeluaran-text">Rp ${pengeluaran.toLocaleString('id-ID')}</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow text-center">
        <p class="text-secondary-light dark:text-secondary-dark text-sm">Saldo</p>
        <p class="text-lg font-semibold text-accent-light dark:text-accent-dark saldo-text">Rp ${saldo.toLocaleString('id-ID')}</p>
      </div>
    </div>
    <form id="form-${type}" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <input type="text" id="desc-${type}" placeholder="Deskripsi (opsional)" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full" />
      <input type="number" id="amount-${type}" placeholder="Jumlah" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full" required />
      <select id="type-${type}" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full">
        <option value="pemasukan">Pemasukan</option>
        <option value="pengeluaran">Pengeluaran</option>
      </select>
      <input type="date" id="date-${type}" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full" value="${now}" />
      <button type="submit" class="col-span-full bg-accent-light dark:bg-accent-dark text-white px-4 py-2 rounded">Simpan Transaksi</button>
      <div class="col-span-full">
        <hr class="my-6 border-t border-border-light dark:border-border-dark">
      </div>
    </form>
    <div class="mb-4 flex flex-col md:flex-row gap-2 md:items-end">
      <div class="flex flex-col">
        <label for="filter-${type}" class="mb-1">Filter Bulan</label>
        <input type="month" id="filter-${type}" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full" />
      </div>
      <div class="flex flex-col">
        <label for="filter-date-${type}" class="mb-1">Filter Tanggal</label>
        <input type="date" id="filter-date-${type}" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full" />
      </div>
      <div class="flex flex-col">
        <label for="filter-tipe-${type}" class="mb-1">Tipe</label>
        <select id="filter-tipe-${type}" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark w-full">
          <option value="">Semua</option>
          <option value="pemasukan">Pemasukan</option>
          <option value="pengeluaran">Pengeluaran</option>
        </select>
      </div>
    </div>
    <div class="overflow-x-auto rounded">
    <table class="w-full min-w-[500px] text-left border border-border-light dark:border-border-dark">
      <thead>
        <tr class="bg-surface-light dark:bg-surface-dark">
          <th class="p-2">Tanggal</th>
          <th class="p-2">Tipe</th>
          <th class="p-2">Jumlah</th>
          <th class="p-2">Deskripsi</th>
          <th class="p-2 text-center">Aksi</th>
        </tr>
      </thead>
      <tbody id="table-${type}"></tbody>
    </table>
    <div id="pagination-${type}" class="flex justify-between items-center mt-2"></div>
    </div>`;

            const form = document.getElementById(`form-${type}`);
            const tableBody = document.getElementById(`table-${type}`);
            const filter = document.getElementById(`filter-${type}`);
            const pagination = document.getElementById(`pagination-${type}`);
            const filterDate = document.getElementById(`filter-date-${type}`);
            const filterTipe = document.getElementById(`filter-tipe-${type}`);

            // Pagination state
            let currentPage = 1;
            const pageSize = 10;

            function renderTable(data, month = '', page = 1) {
                tableBody.innerHTML = '';
                // Ambil filter tambahan
                const filterDate = document.getElementById(`filter-date-${type}`).value;
                const filterTipe = document.getElementById(`filter-tipe-${type}`).value;
                // Filter data
                let filteredData = data.filter(tx => {
                    let match = true;
                    if (month) match = match && tx.date.startsWith(month);
                    if (filterDate) match = match && tx.date === filterDate;
                    if (filterTipe) match = match && tx.type === filterTipe;
                    return match;
                });
                // Urutkan data desc (terbaru di atas)
                filteredData.sort((a, b) => b.date.localeCompare(a.date));
                const total = filteredData.length;
                const totalPages = Math.ceil(total / pageSize) || 1;
                if (page > totalPages) page = totalPages;
                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                const pageData = filteredData.slice(start, end);
                pageData.forEach((tx) => {
                    const badgeClass = tx.type === 'pemasukan'
                        ? 'inline-block w-24 text-center px-2 py-1 text-xs rounded bg-success-light dark:bg-success-dark text-white'
                        : 'inline-block w-24 text-center px-2 py-1 text-xs rounded bg-danger-light dark:bg-danger-dark text-white';
                    tableBody.innerHTML += `
<tr>
  <td class="p-2">${tx.date}</td>
  <td class="p-2"><span class="${badgeClass}">${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</span></td>
  <td class="p-2">Rp ${parseInt(tx.amount).toLocaleString('id-ID')}</td>
  <td class="p-2">${tx.desc || '-'} </td>
  <td class="p-2 text-center">
    <button class="delete-btn" data-id="${tx.id}" title="Hapus">
      <i class="fas fa-trash text-red-500 hover:text-red-700"></i>
    </button>
  </td>
</tr>`;
                });
                // Render pagination
                pagination.innerHTML = `
            <button id="prev-${type}" class="px-3 py-1 rounded border mr-2 ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-accent-light dark:hover:bg-accent-dark'}" ${page === 1 ? 'disabled' : ''}>Prev</button>
            <span>Halaman ${page} dari ${totalPages}</span>
            <button id="next-${type}" class="px-3 py-1 rounded border ml-2 ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-accent-light dark:hover:bg-accent-dark'}" ${page === totalPages ? 'disabled' : ''}>Next</button>
        `;
                document.getElementById(`prev-${type}`).onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderTable(data, filter.value, currentPage);
                    }
                };
                document.getElementById(`next-${type}`).onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTable(data, filter.value, currentPage);
                    }
                };
                // Pasang ulang event listener tombol hapus setelah render
                setDeleteBtnListeners();
            }

            function setDeleteBtnListeners() {
                Array.from(document.querySelectorAll('.delete-btn')).forEach(btn => {
                    btn.onclick = function (e) {
                        e.preventDefault();
                        const delId = this.getAttribute('data-id');
                        Swal.fire({
                            title: 'Hapus Data?',
                            text: 'Data transaksi akan dihapus secara permanen!',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Hapus',
                            cancelButtonText: 'Batal',
                            customClass: { popup: 'rounded-lg' }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                data = data.filter(tx => tx.id !== delId);
                                localStorage.setItem(dataKey, JSON.stringify(data));
                                renderTable(data, filter.value, currentPage);
                                updateSummary();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Terhapus!',
                                    text: 'Data berhasil dihapus.',
                                    timer: 1200,
                                    showConfirmButton: false,
                                    customClass: { popup: 'rounded-lg' }
                                });
                            }
                        });
                    };
                });
            }

            // Event filter
            document.getElementById(`filter-${type}`).oninput = () => {
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
            };
            document.getElementById(`filter-date-${type}`).oninput = () => {
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
            };
            document.getElementById(`filter-tipe-${type}`).oninput = () => {
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
            };

            renderTable(data);

            form.onsubmit = (e) => {
                e.preventDefault();
                const newData = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5), // id unik
                    desc: document.getElementById(`desc-${type}`).value,
                    amount: document.getElementById(`amount-${type}`).value,
                    type: document.getElementById(`type-${type}`).value,
                    date: document.getElementById(`date-${type}`).value || now
                };
                data.push(newData);
                localStorage.setItem(dataKey, JSON.stringify(data));
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
                updateSummary();
                // Reset form
                form.reset();
                document.getElementById(`date-${type}`).value = now;
            };

            filter.oninput = () => {
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
            };

            filterDate.oninput = () => {
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
            };

            filterTipe.onchange = () => {
                currentPage = 1;
                renderTable(data, filter.value, currentPage);
            };

            // Setelah render, pasang event listener untuk tombol hapus
            Array.from(document.querySelectorAll('.delete-btn')).forEach(btn => {
                btn.onclick = function (e) {
                    e.preventDefault();
                    const delId = this.getAttribute('data-id');
                    Swal.fire({
                        title: 'Hapus Data?',
                        text: 'Data transaksi akan dihapus secara permanen!',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Hapus',
                        cancelButtonText: 'Batal',
                        customClass: { popup: 'rounded-lg' }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Hapus berdasarkan id unik
                            data = data.filter(tx => tx.id !== delId);
                            localStorage.setItem(dataKey, JSON.stringify(data));
                            renderTable(data, filter.value, currentPage);
                            updateSummary();
                            Swal.fire({
                                icon: 'success',
                                title: 'Terhapus!',
                                text: 'Data berhasil dihapus.',
                                timer: 1200,
                                showConfirmButton: false,
                                customClass: { popup: 'rounded-lg' }
                            });
                        }
                    });
                };
            });
        }

        function loadReport() {
            setActiveMenu('report');
            const app = document.getElementById('app');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            // Format bulan Indonesia
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const monthLabel = monthNames[currentMonth] + ' ' + currentYear;
            app.innerHTML = `
        <h2 class="text-2xl font-semibold mb-4">Laporan Statistik Usaha Bulan ${monthLabel}</h2>
        <div class="flex flex-col sm:flex-row gap-4 mb-6 items-start sm:items-end">
            <div>
                <label for="export-usaha" class="block text-sm mb-1 font-medium">Pilih Usaha</label>
                <select id="export-usaha" class="p-2 rounded border border-border-light dark:border-border-dark bg-base-light dark:bg-base-dark">
                    <option value="geprek">Geprek</option>
                    <option value="kaos">Kaos</option>
                </select>
            </div>
            <div class="flex gap-2 mt-2 sm:mt-0">
                <button onclick="exportExcel()" class="bg-success-light dark:bg-success-dark text-white px-4 py-2 rounded flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> Ekspor Excel
                </button>
                <button onclick="exportPDF()" class="bg-danger-light dark:bg-danger-dark text-white px-4 py-2 rounded flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> Ekspor PDF
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow overflow-x-auto">
                <h3 class="mb-2 font-semibold">Geprek</h3>
                <div style="min-width:600px;">
                    <canvas id="report-chart-geprek" height="180" style="min-width:600px;"></canvas>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow overflow-x-auto">
                <h3 class="mb-2 font-semibold">Kaos</h3>
                <div style="min-width:600px;">
                    <canvas id="report-chart-kaos" height="180" style="min-width:600px;"></canvas>
                </div>
            </div>
        </div>
    `;
            renderLineChart('geprek', currentYear, currentMonth, monthNames);
            renderLineChart('kaos', currentYear, currentMonth, monthNames);
        }

        function renderLineChart(type, year, month, monthNames) {
            const ctx = document.getElementById(`report-chart-${type}`);
            const data = JSON.parse(localStorage.getItem(`transaksi-${type}`) || '[]');
            // Ambil transaksi bulan berjalan
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const filtered = data.filter(tx => tx.date && tx.date.startsWith(monthStr));
            // Ambil tanggal unik (hanya tanggal yang ada transaksi)
            let uniqueDates = [...new Set(filtered.map(tx => tx.date))].sort();
            let labels = uniqueDates.map(date => String(Number(date.slice(8, 10))));
            let pemasukanPerTanggal = uniqueDates.map(date => {
                return filtered.filter(tx => tx.date === date && tx.type === 'pemasukan')
                    .reduce((a, b) => a + Number(b.amount), 0);
            });
            let pengeluaranPerTanggal = uniqueDates.map(date => {
                return filtered.filter(tx => tx.date === date && tx.type === 'pengeluaran')
                    .reduce((a, b) => a + Number(b.amount), 0);
            });
            // Jika tanggal pertama bukan 1, tambahkan titik 0 di awal
            if (labels.length && labels[0] !== '1') {
                labels = ['1', ...labels];
                pemasukanPerTanggal = [0, ...pemasukanPerTanggal];
                pengeluaranPerTanggal = [0, ...pengeluaranPerTanggal];
                uniqueDates = [`${year}-${String(month + 1).padStart(2, '0')}-01`, ...uniqueDates];
            }
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: pemasukanPerTanggal,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16,185,129,0.1)',
                            fill: false,
                            tension: 0.5,
                            pointBackgroundColor: '#10B981',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderWidth: 3
                        },
                        {
                            label: 'Pengeluaran',
                            data: pengeluaranPerTanggal,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239,68,68,0.1)',
                            fill: false,
                            tension: 0.5,
                            pointBackgroundColor: '#EF4444',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    const idx = context[0].dataIndex;
                                    const date = uniqueDates[idx];
                                    const [y, m, d] = date.split('-');
                                    return `Tanggal ${d} ${monthNames[parseInt(m, 10) - 1]} ${y}`;
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: Rp ${context.parsed.y.toLocaleString('id-ID')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMin: 0
                        }
                    }
                }
            });
        }

        function exportExcel() {
            // Ambil pilihan usaha dari dropdown di halaman report
            let type = '';
            const usahaSelect = document.getElementById('export-usaha');
            if (usahaSelect) {
                type = usahaSelect.value;
            } else {
                if (document.getElementById('menu-geprek').classList.contains('bg-accent-light') || document.getElementById('menu-geprek').classList.contains('dark:bg-accent-dark')) {
                    type = 'geprek';
                } else if (document.getElementById('menu-kaos').classList.contains('bg-accent-light') || document.getElementById('menu-kaos').classList.contains('dark:bg-accent-dark')) {
                    type = 'kaos';
                } else {
                    Swal.fire({ icon: 'info', title: 'Pilih menu usaha dulu', text: 'Ekspor hanya bisa dari menu Geprek/Kaos', customClass: { popup: 'rounded-lg' } }); return;
                }
            }
            const data = JSON.parse(localStorage.getItem(`transaksi-${type}`) || '[]');
            if (!data.length) {
                Swal.fire({ icon: 'info', title: 'Tidak ada data', text: 'Belum ada transaksi untuk diekspor.', customClass: { popup: 'rounded-lg' } }); return;
            }
            // Ambil bulan dan tahun aktif (default: bulan sekarang)
            const now = new Date();
            let month = now.getMonth();
            let year = now.getFullYear();
            let monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            let bulanLabel = monthNames[month] + ' ' + year;
            // Judul report
            const judul = `Laporan Transaksi Usaha ${type.charAt(0).toUpperCase() + type.slice(1)} Bulan ${bulanLabel}`;
            // Siapkan data untuk Excel
            const wsData = [
                [judul],
                ['Tanggal', 'Tipe', 'Jumlah', 'Deskripsi']
            ];
            data.forEach(tx => {
                wsData.push([
                    tx.date,
                    tx.type.charAt(0).toUpperCase() + tx.type.slice(1),
                    'Rp ' + parseInt(tx.amount).toLocaleString('id-ID'),
                    tx.desc || '-'
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            // Merge cell judul
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }];
            // Auto width kolom
            ws['!cols'] = [
                { wch: 12 }, { wch: 30 }, { wch: 18 }, { wch: 14 }
            ];
            // Catatan styling: warna header hanya bisa diubah manual di Excel, tidak bisa otomatis dari browser.
            // Judul tetap di tengah (merge cell), header tabel otomatis bold oleh Excel.
            // Tambahkan catatan pada judul jika perlu styling lebih lanjut.
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, type.charAt(0).toUpperCase() + type.slice(1));
            XLSX.writeFile(wb, `Transaksi_${type}_${now.toISOString().slice(0, 10)}.xlsx`);
        }

        function exportPDF() {
            let type = '';
            const usahaSelect = document.getElementById('export-usaha');
            if (usahaSelect) {
                type = usahaSelect.value;
            } else {
                if (document.getElementById('menu-geprek').classList.contains('bg-accent-light') || document.getElementById('menu-geprek').classList.contains('dark:bg-accent-dark')) {
                    type = 'geprek';
                } else if (document.getElementById('menu-kaos').classList.contains('bg-accent-light') || document.getElementById('menu-kaos').classList.contains('dark:bg-accent-dark')) {
                    type = 'kaos';
                } else {
                    Swal.fire({ icon: 'info', title: 'Pilih menu usaha dulu', text: 'Ekspor hanya bisa dari menu Geprek/Kaos', customClass: { popup: 'rounded-lg' } }); return;
                }
            }
            const data = JSON.parse(localStorage.getItem(`transaksi-${type}`) || '[]');
            if (!data.length) {
                Swal.fire({ icon: 'info', title: 'Tidak ada data', text: 'Belum ada transaksi untuk diekspor.', customClass: { popup: 'rounded-lg' } }); return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            // Judul utama
            const now = new Date();
            let month = now.getMonth();
            let year = now.getFullYear();
            let monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            let bulanLabel = monthNames[month] + ' ' + year;
            const judul1 = `Laporan Transaksi Usaha ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const judul2 = `Bulan ${bulanLabel}`;
            // Set font dan posisi judul utama
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const pageWidth = doc.internal.pageSize.getWidth();
            const textWidth1 = doc.getTextWidth(judul1);
            const x1 = (pageWidth - textWidth1) / 2;
            doc.text(judul1, x1, 18);
            // Judul kedua (bulan), font bold dan ukuran sama, di bawah judul utama
            const textWidth2 = doc.getTextWidth(judul2);
            const x2 = (pageWidth - textWidth2) / 2;
            doc.text(judul2, x2, 28); // 28 = 18 + 10pt (2 spasi)
            // Subjudul tanggal ekspor
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Tanggal ekspor: ${new Date().toLocaleDateString('id-ID')}`, 14, 36);
            // Siapkan data tabel
            const tableData = data.map(tx => [
                tx.date,
                tx.type.charAt(0).toUpperCase() + tx.type.slice(1),
                'Rp ' + parseInt(tx.amount).toLocaleString('id-ID'),
                tx.desc || '-'
            ]);
            // Jarak judul ke tabel: startY = 46 (sekitar 2-3 spasi dari judul2)
            doc.autoTable({
                head: [['Tanggal', 'Tipe', 'Jumlah', 'Deskripsi']],
                body: tableData,
                startY: 46,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246] },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { left: 14, right: 14 }
            });
            doc.save(`Transaksi_${type}_${now.toISOString().slice(0, 10)}.pdf`);
        }

        // Live search data
        const searchData = [
            { label: 'Dashboard', action: () => loadDashboard() },
            { label: 'Transaksi Geprek', action: () => loadContent('geprek') },
            { label: 'Transaksi Kaos', action: () => loadContent('kaos') },
            { label: 'Report', action: () => loadReport() },
        ];

        function setupLiveSearch(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            input.addEventListener('input', function () {
                const keyword = this.value.trim().toLowerCase();
                if (!keyword) {
                    suggestions.classList.add('hidden');
                    suggestions.innerHTML = '';
                    return;
                }
                const filtered = searchData.filter(item => item.label.toLowerCase().includes(keyword));
                if (filtered.length === 0) {
                    suggestions.classList.add('hidden');
                    suggestions.innerHTML = '';
                    return;
                }
                suggestions.innerHTML = filtered.map(item => `<li class='px-4 py-2 cursor-pointer hover:bg-accent-light dark:hover:bg-accent-dark hover:text-white' data-label="${item.label}">${item.label}</li>`).join('');
                suggestions.classList.remove('hidden');
            });
            suggestions.addEventListener('mousedown', function (e) {
                if (e.target.tagName === 'LI') {
                    const label = e.target.getAttribute('data-label');
                    const found = searchData.find(item => item.label === label);
                    if (found) found.action();
                    suggestions.classList.add('hidden');
                    input.value = '';
                }
            });
            // Hide suggestions on blur
            input.addEventListener('blur', function () {
                setTimeout(() => suggestions.classList.add('hidden'), 100);
            });
        }
        setupLiveSearch('mobile-search', 'mobile-search-suggestions');
        setupLiveSearch('desktop-search', 'desktop-search-suggestions');

        window.onload = () => {
            loadTheme();
            loadDashboard();
        }
    </script>
</body>

</html>